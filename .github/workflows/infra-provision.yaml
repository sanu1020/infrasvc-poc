name: Infra Provisioning Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
            role-to-assume: "arn:aws:iam::985504043303:role/infra-svc-poc-role"
            aws-region: "us-east-1"

      # Install the latest version of Terragrunt CLI and configure the Terragrunt CLI configuration file with a Terragrunt Cloud user API token
      - name: Setup Terraform v1.2.6
        uses: hashicorp/setup-Terraform@v1
        with:
          terraform_version: 1.2.6
          terraform_wrapper: true

      - name: Setup Terraform version
        run: terraform --version
        
      - name: Setup Terraform wrapper path
        run: which terraform

      - name: Setup Terragrunt v0.38.4
        run: |
          sudo wget -q -O /bin/terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/v0.38.4/terragrunt_linux_amd64"
          sudo chmod +x /bin/terragrunt
          terragrunt -v

      - name: terragrunt initiate
        run: terragrunt init --terragrunt-non-interactive
        working-directory: ./infrastructure-live-v3

      - name: Terragrunt Plan
        run: terragrunt run-all plan --terragrunt-non-interactive
        working-directory: ./infrastructure-live-v3

      - name: terragrunt apply
        run: terragrunt run-all apply --terragrunt-non-interactive
        working-directory: ./infrastructure-live-v3
